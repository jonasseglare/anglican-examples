;; gorilla-repl.fileformat = 1

;; **
;;; # Geometric
;;; 
;;; In probabilistic programming systems like Anglican that support recursion and branching on nondeterminism, it is possible to write procedures in the language itself that sample from distributions with countable support.  Another way of saying this is that we can denote constructive definitions of distribution over countable support and sample from the same. In this worksheet, we'll show how you can use this property of the language to define a geometric distribution using the Bernoulli distribution.
;; **

;; @@
(ns geometric
    (:require [gorilla-plot.core :as plot]
            [clojure.core.matrix :as m]
            [anglican.stat :as s]
            :reload)
  (:use clojure.repl
        [anglican core runtime emit]))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}
;; <=

;; **
;;; We could prepare a geometric sampler in a number of different ways; here are two reasonable approaches:
;; **

;; @@
(defn geometric1 
  "generates geometrically distributed values in {0,1,2,...}"
  ([p] (geometric1 p 0))
  ([p n] (if (sample* (flip p))
           n 
           (geometric1 p (+ n 1)))))

(defn geometric2 [p]
  "generates geometrically distributed values in {0,1,2,...}"
  (loop [n 0] 
    (if (sample* (flip p)) 
      n 
      (recur (inc n)))))
;; @@
;; =>
;;; {"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"html","content":"<span class='clj-var'>#&#x27;geometric/geometric1</span>","value":"#'geometric/geometric1"},{"type":"html","content":"<span class='clj-var'>#&#x27;geometric/geometric2</span>","value":"#'geometric/geometric2"}],"value":"[#'geometric/geometric1,#'geometric/geometric2]"}
;; <=

;; **
;;; We can check that these functions produce samples that are in accordance with our understanding of the geometric distribution - which they do.
;; **

;; @@
(defn update-values [m f & args]
  "update values in map m using f val args applied to each element of m"
  (reduce (fn [r [k v]] (assoc r k (apply f v args))) {} m))

(defn estimate-empirical-discrete-dist-from-generator [f c]
  "given sample generator f and a sample count c to use"
  (let [bucket-size 1
        bucketed-counts (->> f
     				(repeatedly c)
     				(group-by #(quot % bucket-size))
     				(map #(hash-map (first %) ((comp count second) %)))
   					(into (sorted-map)))]
    (into (sorted-map) 
          (update-values 
            bucketed-counts 
            #(float (/ % (reduce + (vals bucketed-counts))))))))


(def geometric1dist (estimate-empirical-discrete-dist-from-generator (partial geometric1 0.2) 10000))       

(def geometric2dist (estimate-empirical-discrete-dist-from-generator (partial geometric2 0.2) 10000)) 

(plot/compose (plot/list-plot geometric1dist) (plot/list-plot geometric2dist))
geometric2dist
;; @@
;; =>
;;; {"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"html","content":"<span class='clj-var'>#&#x27;geometric/update-values</span>","value":"#'geometric/update-values"},{"type":"html","content":"<span class='clj-var'>#&#x27;geometric/estimate-empirical-discrete-dist-from-generator</span>","value":"#'geometric/estimate-empirical-discrete-dist-from-generator"}],"value":"[#'geometric/update-values,#'geometric/estimate-empirical-discrete-dist-from-generator]"},{"type":"html","content":"<span class='clj-var'>#&#x27;geometric/geometric1dist</span>","value":"#'geometric/geometric1dist"}],"value":"[[#'geometric/update-values,#'geometric/estimate-empirical-discrete-dist-from-generator],#'geometric/geometric1dist]"},{"type":"html","content":"<span class='clj-var'>#&#x27;geometric/geometric2dist</span>","value":"#'geometric/geometric2dist"}],"value":"[[[#'geometric/update-values,#'geometric/estimate-empirical-discrete-dist-from-generator],#'geometric/geometric1dist],#'geometric/geometric2dist]"},{"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":{"data":"03bd5c12-7ad7-43da-9838-7598ada31f0f","field":"data.x"}},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":{"data":"03bd5c12-7ad7-43da-9838-7598ada31f0f","field":"data.y"}}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}],"data":[{"name":"03bd5c12-7ad7-43da-9838-7598ada31f0f","values":[{"x":0,"y":0.20569999516010284},{"x":1,"y":0.16099999845027924},{"x":2,"y":0.12710000574588776},{"x":3,"y":0.1005999967455864},{"x":4,"y":0.08290000259876251},{"x":5,"y":0.06830000132322311},{"x":6,"y":0.05209999904036522},{"x":7,"y":0.03739999979734421},{"x":8,"y":0.03099999949336052},{"x":9,"y":0.02710000053048134},{"x":10,"y":0.019899999722838402},{"x":11,"y":0.016100000590085983},{"x":12,"y":0.014499999582767487},{"x":13,"y":0.011099999770522118},{"x":14,"y":0.008799999952316284},{"x":15,"y":0.007799999788403511},{"x":16,"y":0.006099999882280827},{"x":17,"y":0.003800000064074993},{"x":18,"y":0.003700000001117587},{"x":19,"y":0.0026000000070780516},{"x":20,"y":0.00279999990016222},{"x":21,"y":0.002199999988079071},{"x":22,"y":0.001500000013038516},{"x":23,"y":0.0012000000569969416},{"x":24,"y":0.0012000000569969416},{"x":25,"y":0.0005000000237487257},{"x":26,"y":0.0006000000284984708},{"x":27,"y":0.000699999975040555},{"x":28,"y":0.00039999998989515007},{"x":29,"y":0.00019999999494757503},{"x":30,"y":0.00009999999747378752},{"x":31,"y":0.00009999999747378752},{"x":32,"y":0.0003000000142492354},{"x":33,"y":0.00009999999747378752},{"x":34,"y":0.00019999999494757503},{"x":36,"y":0.00009999999747378752},{"x":50,"y":0.00009999999747378752},{"x":55,"y":0.00009999999747378752}]},{"name":"42ebad73-9192-40e3-844e-b980d40d9194","values":[{"x":0,"y":0.2004999965429306},{"x":1,"y":0.15459999442100525},{"x":2,"y":0.12919999659061432},{"x":3,"y":0.10509999841451645},{"x":4,"y":0.07919999957084656},{"x":5,"y":0.06419999897480011},{"x":6,"y":0.05310000106692314},{"x":7,"y":0.04320000112056732},{"x":8,"y":0.03350000083446503},{"x":9,"y":0.024700000882148743},{"x":10,"y":0.019500000402331352},{"x":11,"y":0.019899999722838402},{"x":12,"y":0.01549999974668026},{"x":13,"y":0.013299999758601189},{"x":14,"y":0.008700000122189522},{"x":15,"y":0.006399999838322401},{"x":16,"y":0.006500000134110451},{"x":17,"y":0.005100000184029341},{"x":18,"y":0.0031999999191612005},{"x":19,"y":0.0027000000700354576},{"x":20,"y":0.0019000000320374966},{"x":21,"y":0.0015999999595806003},{"x":22,"y":0.0017000000225380063},{"x":23,"y":0.001500000013038516},{"x":24,"y":0.0008999999845400453},{"x":25,"y":0.0013000000035390258},{"x":26,"y":0.0007999999797903001},{"x":27,"y":0.0003000000142492354},{"x":28,"y":0.0003000000142492354},{"x":29,"y":0.00039999998989515007},{"x":30,"y":0.0003000000142492354},{"x":31,"y":0.00019999999494757503},{"x":34,"y":0.00019999999494757503},{"x":37,"y":0.00019999999494757503},{"x":38,"y":0.00009999999747378752},{"x":39,"y":0.00019999999494757503}]}],"marks":[{"type":"symbol","from":{"data":"03bd5c12-7ad7-43da-9838-7598ada31f0f"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"fill":{"value":"steelblue"},"fillOpacity":{"value":1}},"update":{"shape":"circle","size":{"value":70},"stroke":{"value":"transparent"}},"hover":{"size":{"value":210},"stroke":{"value":"white"}}}},{"type":"symbol","from":{"data":"42ebad73-9192-40e3-844e-b980d40d9194"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"fill":{"value":"steelblue"},"fillOpacity":{"value":1}},"update":{"shape":"circle","size":{"value":70},"stroke":{"value":"transparent"}},"hover":{"size":{"value":210},"stroke":{"value":"white"}}}}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"03bd5c12-7ad7-43da-9838-7598ada31f0f\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"03bd5c12-7ad7-43da-9838-7598ada31f0f\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}], :data ({:name \"03bd5c12-7ad7-43da-9838-7598ada31f0f\", :values ({:x 0, :y 0.2057} {:x 1, :y 0.161} {:x 2, :y 0.1271} {:x 3, :y 0.1006} {:x 4, :y 0.0829} {:x 5, :y 0.0683} {:x 6, :y 0.0521} {:x 7, :y 0.0374} {:x 8, :y 0.031} {:x 9, :y 0.0271} {:x 10, :y 0.0199} {:x 11, :y 0.0161} {:x 12, :y 0.0145} {:x 13, :y 0.0111} {:x 14, :y 0.0088} {:x 15, :y 0.0078} {:x 16, :y 0.0061} {:x 17, :y 0.0038} {:x 18, :y 0.0037} {:x 19, :y 0.0026} {:x 20, :y 0.0028} {:x 21, :y 0.0022} {:x 22, :y 0.0015} {:x 23, :y 0.0012} {:x 24, :y 0.0012} {:x 25, :y 5.0E-4} {:x 26, :y 6.0E-4} {:x 27, :y 7.0E-4} {:x 28, :y 4.0E-4} {:x 29, :y 2.0E-4} {:x 30, :y 1.0E-4} {:x 31, :y 1.0E-4} {:x 32, :y 3.0E-4} {:x 33, :y 1.0E-4} {:x 34, :y 2.0E-4} {:x 36, :y 1.0E-4} {:x 50, :y 1.0E-4} {:x 55, :y 1.0E-4})} {:name \"42ebad73-9192-40e3-844e-b980d40d9194\", :values ({:x 0, :y 0.2005} {:x 1, :y 0.1546} {:x 2, :y 0.1292} {:x 3, :y 0.1051} {:x 4, :y 0.0792} {:x 5, :y 0.0642} {:x 6, :y 0.0531} {:x 7, :y 0.0432} {:x 8, :y 0.0335} {:x 9, :y 0.0247} {:x 10, :y 0.0195} {:x 11, :y 0.0199} {:x 12, :y 0.0155} {:x 13, :y 0.0133} {:x 14, :y 0.0087} {:x 15, :y 0.0064} {:x 16, :y 0.0065} {:x 17, :y 0.0051} {:x 18, :y 0.0032} {:x 19, :y 0.0027} {:x 20, :y 0.0019} {:x 21, :y 0.0016} {:x 22, :y 0.0017} {:x 23, :y 0.0015} {:x 24, :y 9.0E-4} {:x 25, :y 0.0013} {:x 26, :y 8.0E-4} {:x 27, :y 3.0E-4} {:x 28, :y 3.0E-4} {:x 29, :y 4.0E-4} {:x 30, :y 3.0E-4} {:x 31, :y 2.0E-4} {:x 34, :y 2.0E-4} {:x 37, :y 2.0E-4} {:x 38, :y 1.0E-4} {:x 39, :y 2.0E-4})}), :marks ({:type \"symbol\", :from {:data \"03bd5c12-7ad7-43da-9838-7598ada31f0f\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 1}}, :update {:shape \"circle\", :size {:value 70}, :stroke {:value \"transparent\"}}, :hover {:size {:value 210}, :stroke {:value \"white\"}}}} {:type \"symbol\", :from {:data \"42ebad73-9192-40e3-844e-b980d40d9194\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 1}}, :update {:shape \"circle\", :size {:value 70}, :stroke {:value \"transparent\"}}, :hover {:size {:value 210}, :stroke {:value \"white\"}}}})}}"}],"value":"[[[[#'geometric/update-values,#'geometric/estimate-empirical-discrete-dist-from-generator],#'geometric/geometric1dist],#'geometric/geometric2dist],#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"03bd5c12-7ad7-43da-9838-7598ada31f0f\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"03bd5c12-7ad7-43da-9838-7598ada31f0f\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}], :data ({:name \"03bd5c12-7ad7-43da-9838-7598ada31f0f\", :values ({:x 0, :y 0.2057} {:x 1, :y 0.161} {:x 2, :y 0.1271} {:x 3, :y 0.1006} {:x 4, :y 0.0829} {:x 5, :y 0.0683} {:x 6, :y 0.0521} {:x 7, :y 0.0374} {:x 8, :y 0.031} {:x 9, :y 0.0271} {:x 10, :y 0.0199} {:x 11, :y 0.0161} {:x 12, :y 0.0145} {:x 13, :y 0.0111} {:x 14, :y 0.0088} {:x 15, :y 0.0078} {:x 16, :y 0.0061} {:x 17, :y 0.0038} {:x 18, :y 0.0037} {:x 19, :y 0.0026} {:x 20, :y 0.0028} {:x 21, :y 0.0022} {:x 22, :y 0.0015} {:x 23, :y 0.0012} {:x 24, :y 0.0012} {:x 25, :y 5.0E-4} {:x 26, :y 6.0E-4} {:x 27, :y 7.0E-4} {:x 28, :y 4.0E-4} {:x 29, :y 2.0E-4} {:x 30, :y 1.0E-4} {:x 31, :y 1.0E-4} {:x 32, :y 3.0E-4} {:x 33, :y 1.0E-4} {:x 34, :y 2.0E-4} {:x 36, :y 1.0E-4} {:x 50, :y 1.0E-4} {:x 55, :y 1.0E-4})} {:name \"42ebad73-9192-40e3-844e-b980d40d9194\", :values ({:x 0, :y 0.2005} {:x 1, :y 0.1546} {:x 2, :y 0.1292} {:x 3, :y 0.1051} {:x 4, :y 0.0792} {:x 5, :y 0.0642} {:x 6, :y 0.0531} {:x 7, :y 0.0432} {:x 8, :y 0.0335} {:x 9, :y 0.0247} {:x 10, :y 0.0195} {:x 11, :y 0.0199} {:x 12, :y 0.0155} {:x 13, :y 0.0133} {:x 14, :y 0.0087} {:x 15, :y 0.0064} {:x 16, :y 0.0065} {:x 17, :y 0.0051} {:x 18, :y 0.0032} {:x 19, :y 0.0027} {:x 20, :y 0.0019} {:x 21, :y 0.0016} {:x 22, :y 0.0017} {:x 23, :y 0.0015} {:x 24, :y 9.0E-4} {:x 25, :y 0.0013} {:x 26, :y 8.0E-4} {:x 27, :y 3.0E-4} {:x 28, :y 3.0E-4} {:x 29, :y 4.0E-4} {:x 30, :y 3.0E-4} {:x 31, :y 2.0E-4} {:x 34, :y 2.0E-4} {:x 37, :y 2.0E-4} {:x 38, :y 1.0E-4} {:x 39, :y 2.0E-4})}), :marks ({:type \"symbol\", :from {:data \"03bd5c12-7ad7-43da-9838-7598ada31f0f\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 1}}, :update {:shape \"circle\", :size {:value 70}, :stroke {:value \"transparent\"}}, :hover {:size {:value 210}, :stroke {:value \"white\"}}}} {:type \"symbol\", :from {:data \"42ebad73-9192-40e3-844e-b980d40d9194\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 1}}, :update {:shape \"circle\", :size {:value 70}, :stroke {:value \"transparent\"}}, :hover {:size {:value 210}, :stroke {:value \"white\"}}}})}}]"},{"type":"list-like","open":"<span class='clj-map'>{</span>","close":"<span class='clj-map'>}</span>","separator":", ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-unkown'>0.2005</span>","value":"0.2005"}],"value":"[0 0.2005]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-unkown'>0.1546</span>","value":"0.1546"}],"value":"[1 0.1546]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>2</span>","value":"2"},{"type":"html","content":"<span class='clj-unkown'>0.1292</span>","value":"0.1292"}],"value":"[2 0.1292]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>3</span>","value":"3"},{"type":"html","content":"<span class='clj-unkown'>0.1051</span>","value":"0.1051"}],"value":"[3 0.1051]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>4</span>","value":"4"},{"type":"html","content":"<span class='clj-unkown'>0.0792</span>","value":"0.0792"}],"value":"[4 0.0792]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>5</span>","value":"5"},{"type":"html","content":"<span class='clj-unkown'>0.0642</span>","value":"0.0642"}],"value":"[5 0.0642]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>6</span>","value":"6"},{"type":"html","content":"<span class='clj-unkown'>0.0531</span>","value":"0.0531"}],"value":"[6 0.0531]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>7</span>","value":"7"},{"type":"html","content":"<span class='clj-unkown'>0.0432</span>","value":"0.0432"}],"value":"[7 0.0432]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>8</span>","value":"8"},{"type":"html","content":"<span class='clj-unkown'>0.0335</span>","value":"0.0335"}],"value":"[8 0.0335]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>9</span>","value":"9"},{"type":"html","content":"<span class='clj-unkown'>0.0247</span>","value":"0.0247"}],"value":"[9 0.0247]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>10</span>","value":"10"},{"type":"html","content":"<span class='clj-unkown'>0.0195</span>","value":"0.0195"}],"value":"[10 0.0195]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>11</span>","value":"11"},{"type":"html","content":"<span class='clj-unkown'>0.0199</span>","value":"0.0199"}],"value":"[11 0.0199]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>12</span>","value":"12"},{"type":"html","content":"<span class='clj-unkown'>0.0155</span>","value":"0.0155"}],"value":"[12 0.0155]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>13</span>","value":"13"},{"type":"html","content":"<span class='clj-unkown'>0.0133</span>","value":"0.0133"}],"value":"[13 0.0133]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>14</span>","value":"14"},{"type":"html","content":"<span class='clj-unkown'>0.0087</span>","value":"0.0087"}],"value":"[14 0.0087]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>15</span>","value":"15"},{"type":"html","content":"<span class='clj-unkown'>0.0064</span>","value":"0.0064"}],"value":"[15 0.0064]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>16</span>","value":"16"},{"type":"html","content":"<span class='clj-unkown'>0.0065</span>","value":"0.0065"}],"value":"[16 0.0065]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>17</span>","value":"17"},{"type":"html","content":"<span class='clj-unkown'>0.0051</span>","value":"0.0051"}],"value":"[17 0.0051]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>18</span>","value":"18"},{"type":"html","content":"<span class='clj-unkown'>0.0032</span>","value":"0.0032"}],"value":"[18 0.0032]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>19</span>","value":"19"},{"type":"html","content":"<span class='clj-unkown'>0.0027</span>","value":"0.0027"}],"value":"[19 0.0027]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>20</span>","value":"20"},{"type":"html","content":"<span class='clj-unkown'>0.0019</span>","value":"0.0019"}],"value":"[20 0.0019]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>21</span>","value":"21"},{"type":"html","content":"<span class='clj-unkown'>0.0016</span>","value":"0.0016"}],"value":"[21 0.0016]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>22</span>","value":"22"},{"type":"html","content":"<span class='clj-unkown'>0.0017</span>","value":"0.0017"}],"value":"[22 0.0017]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>23</span>","value":"23"},{"type":"html","content":"<span class='clj-unkown'>0.0015</span>","value":"0.0015"}],"value":"[23 0.0015]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>24</span>","value":"24"},{"type":"html","content":"<span class='clj-unkown'>9.0E-4</span>","value":"9.0E-4"}],"value":"[24 9.0E-4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>25</span>","value":"25"},{"type":"html","content":"<span class='clj-unkown'>0.0013</span>","value":"0.0013"}],"value":"[25 0.0013]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>26</span>","value":"26"},{"type":"html","content":"<span class='clj-unkown'>8.0E-4</span>","value":"8.0E-4"}],"value":"[26 8.0E-4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>27</span>","value":"27"},{"type":"html","content":"<span class='clj-unkown'>3.0E-4</span>","value":"3.0E-4"}],"value":"[27 3.0E-4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>28</span>","value":"28"},{"type":"html","content":"<span class='clj-unkown'>3.0E-4</span>","value":"3.0E-4"}],"value":"[28 3.0E-4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>29</span>","value":"29"},{"type":"html","content":"<span class='clj-unkown'>4.0E-4</span>","value":"4.0E-4"}],"value":"[29 4.0E-4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>30</span>","value":"30"},{"type":"html","content":"<span class='clj-unkown'>3.0E-4</span>","value":"3.0E-4"}],"value":"[30 3.0E-4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>31</span>","value":"31"},{"type":"html","content":"<span class='clj-unkown'>2.0E-4</span>","value":"2.0E-4"}],"value":"[31 2.0E-4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>34</span>","value":"34"},{"type":"html","content":"<span class='clj-unkown'>2.0E-4</span>","value":"2.0E-4"}],"value":"[34 2.0E-4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>37</span>","value":"37"},{"type":"html","content":"<span class='clj-unkown'>2.0E-4</span>","value":"2.0E-4"}],"value":"[37 2.0E-4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>38</span>","value":"38"},{"type":"html","content":"<span class='clj-unkown'>1.0E-4</span>","value":"1.0E-4"}],"value":"[38 1.0E-4]"},{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>39</span>","value":"39"},{"type":"html","content":"<span class='clj-unkown'>2.0E-4</span>","value":"2.0E-4"}],"value":"[39 2.0E-4]"}],"value":"{0 0.2005, 1 0.1546, 2 0.1292, 3 0.1051, 4 0.0792, 5 0.0642, 6 0.0531, 7 0.0432, 8 0.0335, 9 0.0247, 10 0.0195, 11 0.0199, 12 0.0155, 13 0.0133, 14 0.0087, 15 0.0064, 16 0.0065, 17 0.0051, 18 0.0032, 19 0.0027, 20 0.0019, 21 0.0016, 22 0.0017, 23 0.0015, 24 9.0E-4, 25 0.0013, 26 8.0E-4, 27 3.0E-4, 28 3.0E-4, 29 4.0E-4, 30 3.0E-4, 31 2.0E-4, 34 2.0E-4, 37 2.0E-4, 38 1.0E-4, 39 2.0E-4}"}],"value":"[[[[[#'geometric/update-values,#'geometric/estimate-empirical-discrete-dist-from-generator],#'geometric/geometric1dist],#'geometric/geometric2dist],#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain {:data \"03bd5c12-7ad7-43da-9838-7598ada31f0f\", :field \"data.x\"}} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain {:data \"03bd5c12-7ad7-43da-9838-7598ada31f0f\", :field \"data.y\"}}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}], :data ({:name \"03bd5c12-7ad7-43da-9838-7598ada31f0f\", :values ({:x 0, :y 0.2057} {:x 1, :y 0.161} {:x 2, :y 0.1271} {:x 3, :y 0.1006} {:x 4, :y 0.0829} {:x 5, :y 0.0683} {:x 6, :y 0.0521} {:x 7, :y 0.0374} {:x 8, :y 0.031} {:x 9, :y 0.0271} {:x 10, :y 0.0199} {:x 11, :y 0.0161} {:x 12, :y 0.0145} {:x 13, :y 0.0111} {:x 14, :y 0.0088} {:x 15, :y 0.0078} {:x 16, :y 0.0061} {:x 17, :y 0.0038} {:x 18, :y 0.0037} {:x 19, :y 0.0026} {:x 20, :y 0.0028} {:x 21, :y 0.0022} {:x 22, :y 0.0015} {:x 23, :y 0.0012} {:x 24, :y 0.0012} {:x 25, :y 5.0E-4} {:x 26, :y 6.0E-4} {:x 27, :y 7.0E-4} {:x 28, :y 4.0E-4} {:x 29, :y 2.0E-4} {:x 30, :y 1.0E-4} {:x 31, :y 1.0E-4} {:x 32, :y 3.0E-4} {:x 33, :y 1.0E-4} {:x 34, :y 2.0E-4} {:x 36, :y 1.0E-4} {:x 50, :y 1.0E-4} {:x 55, :y 1.0E-4})} {:name \"42ebad73-9192-40e3-844e-b980d40d9194\", :values ({:x 0, :y 0.2005} {:x 1, :y 0.1546} {:x 2, :y 0.1292} {:x 3, :y 0.1051} {:x 4, :y 0.0792} {:x 5, :y 0.0642} {:x 6, :y 0.0531} {:x 7, :y 0.0432} {:x 8, :y 0.0335} {:x 9, :y 0.0247} {:x 10, :y 0.0195} {:x 11, :y 0.0199} {:x 12, :y 0.0155} {:x 13, :y 0.0133} {:x 14, :y 0.0087} {:x 15, :y 0.0064} {:x 16, :y 0.0065} {:x 17, :y 0.0051} {:x 18, :y 0.0032} {:x 19, :y 0.0027} {:x 20, :y 0.0019} {:x 21, :y 0.0016} {:x 22, :y 0.0017} {:x 23, :y 0.0015} {:x 24, :y 9.0E-4} {:x 25, :y 0.0013} {:x 26, :y 8.0E-4} {:x 27, :y 3.0E-4} {:x 28, :y 3.0E-4} {:x 29, :y 4.0E-4} {:x 30, :y 3.0E-4} {:x 31, :y 2.0E-4} {:x 34, :y 2.0E-4} {:x 37, :y 2.0E-4} {:x 38, :y 1.0E-4} {:x 39, :y 2.0E-4})}), :marks ({:type \"symbol\", :from {:data \"03bd5c12-7ad7-43da-9838-7598ada31f0f\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 1}}, :update {:shape \"circle\", :size {:value 70}, :stroke {:value \"transparent\"}}, :hover {:size {:value 210}, :stroke {:value \"white\"}}}} {:type \"symbol\", :from {:data \"42ebad73-9192-40e3-844e-b980d40d9194\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 1}}, :update {:shape \"circle\", :size {:value 70}, :stroke {:value \"transparent\"}}, :hover {:size {:value 210}, :stroke {:value \"white\"}}}})}}],{0 0.2005, 1 0.1546, 2 0.1292, 3 0.1051, 4 0.0792, 5 0.0642, 6 0.0531, 7 0.0432, 8 0.0335, 9 0.0247, 10 0.0195, 11 0.0199, 12 0.0155, 13 0.0133, 14 0.0087, 15 0.0064, 16 0.0065, 17 0.0051, 18 0.0032, 19 0.0027, 20 0.0019, 21 0.0016, 22 0.0017, 23 0.0015, 24 9.0E-4, 25 0.0013, 26 8.0E-4, 27 3.0E-4, 28 3.0E-4, 29 4.0E-4, 30 3.0E-4, 31 2.0E-4, 34 2.0E-4, 37 2.0E-4, 38 1.0E-4, 39 2.0E-4}]"}
;; <=

;; **
;;; What is interesting, however, is that one can't immediately deduce, even in this very simple example, that the return values from these procedures are "scorable" in the sense that they can be "observed" in Anglican. 
;;; 
;;; In order to make these procedures scorable one must, for now, be able to provide an explicit log-pdf/pmf calculator.  
;; **

;; @@
(defdist geometric
  "Geometric distribution on support {0,1,2....}"
  [p] []
    (sample* [this] (geometric2 p))
    (observe* [this value] (+ (log p) (* value (log (- 1 p))))))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-unkown'>#multifn[print-method 0x3c4e70fd]</span>","value":"#multifn[print-method 0x3c4e70fd]"}
;; <=

;; @@
(exp (observe* (geometric 0.2) 6))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-double'>0.052428800000000005</span>","value":"0.052428800000000005"}
;; <=

;; **
;;; One interesting research effort involves writing procedures that can automatically generate scoring functions given sampling code. That is to say, producing a function called ```(derive-score-fn-for geometric)``` that could take in one of the above samplers and deduce a log-pmf.
;; **

;; @@
(geometric 0.2)
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-record'>#geometric.geometric-distribution{</span>","close":"<span class='clj-record'>}</span>","separator":" ","items":[{"type":"list-like","open":"","close":"","separator":" ","items":[{"type":"html","content":"<span class='clj-keyword'>:p</span>","value":":p"},{"type":"html","content":"<span class='clj-double'>0.2</span>","value":"0.2"}],"value":"[:p 0.2]"}],"value":"(geometric/geometric 0.2)"}
;; <=

;; @@
(defquery geometric-query [p]
  "generates geometrically distributed values in {0,1,2,...}"
  (let [dist (flip p)
        until-success (fn until-success [p n] 
                         (if (sample dist)
                           n 
                           (until-success p (+ n 1))))]
       (until-success p 0)))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;geometric/geometric-query</span>","value":"#'geometric/geometric-query"}
;; <=

;; @@
(defquery geometric-query [p]
  "generates geometrically distributed  values in {0,1,2,...}"
  (let [dist (flip p)
        x (loop [n 0]
               (if (sample dist)
                   n 
                   (recur (+ n 1))))]
    x))
;; @@
;; =>
;;; {"type":"html","content":"<span class='clj-var'>#&#x27;geometric/geometric-query</span>","value":"#'geometric/geometric-query"}
;; <=

;; @@
(def geometric-dist (conditional geometric-query :lmh))
(def geometric (geometric-dist 0.4))
;; @@
;; =>
;;; {"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"html","content":"<span class='clj-var'>#&#x27;geometric/geometric-dist</span>","value":"#'geometric/geometric-dist"},{"type":"html","content":"<span class='clj-var'>#&#x27;geometric/geometric</span>","value":"#'geometric/geometric"}],"value":"[#'geometric/geometric-dist,#'geometric/geometric]"}
;; <=

;; @@
(repeatedly 100 #(sample* geometric))
;; @@
;; =>
;;; {"type":"list-like","open":"<span class='clj-lazy-seq'>(</span>","close":"<span class='clj-lazy-seq'>)</span>","separator":" ","items":[{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>2</span>","value":"2"},{"type":"html","content":"<span class='clj-long'>2</span>","value":"2"},{"type":"html","content":"<span class='clj-long'>2</span>","value":"2"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>2</span>","value":"2"},{"type":"html","content":"<span class='clj-long'>7</span>","value":"7"},{"type":"html","content":"<span class='clj-long'>7</span>","value":"7"},{"type":"html","content":"<span class='clj-long'>7</span>","value":"7"},{"type":"html","content":"<span class='clj-long'>7</span>","value":"7"},{"type":"html","content":"<span class='clj-long'>7</span>","value":"7"},{"type":"html","content":"<span class='clj-long'>7</span>","value":"7"},{"type":"html","content":"<span class='clj-long'>6</span>","value":"6"},{"type":"html","content":"<span class='clj-long'>6</span>","value":"6"},{"type":"html","content":"<span class='clj-long'>6</span>","value":"6"},{"type":"html","content":"<span class='clj-long'>5</span>","value":"5"},{"type":"html","content":"<span class='clj-long'>5</span>","value":"5"},{"type":"html","content":"<span class='clj-long'>4</span>","value":"4"},{"type":"html","content":"<span class='clj-long'>3</span>","value":"3"},{"type":"html","content":"<span class='clj-long'>4</span>","value":"4"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>2</span>","value":"2"},{"type":"html","content":"<span class='clj-long'>2</span>","value":"2"},{"type":"html","content":"<span class='clj-long'>2</span>","value":"2"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>3</span>","value":"3"},{"type":"html","content":"<span class='clj-long'>3</span>","value":"3"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>2</span>","value":"2"},{"type":"html","content":"<span class='clj-long'>2</span>","value":"2"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>1</span>","value":"1"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"},{"type":"html","content":"<span class='clj-long'>0</span>","value":"0"}],"value":"(0 0 0 0 0 0 0 0 0 1 1 2 2 2 1 1 1 1 1 1 1 1 1 2 7 7 7 7 7 7 6 6 6 5 5 4 3 4 1 1 1 1 1 0 0 0 1 1 1 1 1 0 0 0 0 0 1 0 0 2 2 2 0 0 0 0 0 0 0 0 0 3 3 0 2 2 0 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0)"}
;; <=
